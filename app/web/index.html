<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Andalus Reels Engine</title>
    <style>
      :root { color-scheme: light; }
      body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #f5f7f6; color: #16221b; }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
      h1 { margin: 0 0 16px; font-size: 28px; }
      .grid { display: grid; grid-template-columns: 360px 1fr; gap: 16px; }
      .card { background: #fff; border: 1px solid #d7e1da; border-radius: 12px; padding: 14px; }
      .card h2 { font-size: 16px; margin: 0 0 10px; }
      .field { display: grid; gap: 6px; margin-bottom: 10px; }
      input, textarea, button { font: inherit; }
      input, textarea { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #c7d3cb; border-radius: 8px; }
      textarea { min-height: 110px; }
      button { border: 0; border-radius: 8px; background: #1d6a4d; color: #fff; padding: 8px 12px; cursor: pointer; }
      button.secondary { background: #3b4c42; }
      button.ghost { background: #e7efea; color: #193024; }
      a.ghost { background: #e7efea; color: #193024; border-radius: 8px; padding: 8px 12px; display: inline-block; }
      .muted { color: #55685d; font-size: 13px; }
      .progress-track { height: 8px; border-radius: 999px; background: #dde8e2; overflow: hidden; margin-top: 8px; }
      .progress-fill { height: 100%; width: 0%; background: #1d6a4d; transition: width 240ms ease; }
      .cli-box { background: #0f1713; color: #d8f0df; padding: 8px 10px; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
      .draft-row { border: 1px solid #d7e1da; border-radius: 10px; padding: 10px; margin-bottom: 8px; background: #fdfefe; }
      .draft-row.active { border-color: #1d6a4d; background: #eef7f1; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .pill { font-size: 12px; border: 1px solid #cad6cf; border-radius: 999px; padding: 2px 8px; }
      .subtitle-table, .timing-table { width: 100%; border-collapse: collapse; font-size: 13px; }
      .subtitle-table th, .subtitle-table td, .timing-table th, .timing-table td { border-bottom: 1px solid #e1e8e4; padding: 8px; text-align: left; vertical-align: top; }
      .subtitle-table input, .timing-table input { padding: 6px; }
      .subtitle-table .text-cell textarea { min-width: 420px; min-height: 86px; resize: vertical; }
      pre { background: #0f1713; color: #d8f0df; padding: 10px; border-radius: 10px; overflow: auto; max-height: 180px; }
      video, audio { width: 100%; margin-top: 8px; border-radius: 10px; background: #000; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } .subtitle-table .text-cell textarea { min-width: 240px; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Andalus Reels Engine</h1>
      <p class="muted">Local dashboard for draft generation, subtitle row editing, and final rendering from already synced website markers.</p>

      <div class="grid">
        <div class="card">
          <h2>Synced Surahs</h2>
          <p class="muted">Markers are synced from the website repo script. Manual JSON paste is disabled.</p>
          <div id="available-days" class="muted">Loading...</div>

          <h2 style="margin-top:20px;">Generate Draft</h2>
          <div class="field"><label>Day</label><select id="gen-day"></select></div>
          <div class="row">
            <div class="field" style="flex:1;"><label>Surah</label><select id="gen-surah"></select></div>
            <div class="field" style="flex:1;"><label>Ayah Start</label><select id="gen-ayah-start"></select></div>
            <div class="field" style="flex:1;"><label>Ayah End</label><select id="gen-ayah-end"></select></div>
          </div>
          <div class="card" style="padding:10px; margin:8px 0; background:#f7fbf8;">
            <p class="muted" style="margin:0 0 6px;">Estimated from synced markers</p>
            <div id="estimate-box" class="muted">Select day/surah/ayah to load estimate.</div>
          </div>
          <div class="row">
            <button id="add-segment-btn" class="ghost">Add Segment</button>
            <button id="clear-segments-btn" class="ghost">Clear Chain</button>
          </div>
          <div id="segment-chain" class="muted" style="margin-top:8px;">No segments in chain.</div>
          <button id="generate-btn" style="margin-top:8px;">Start Draft From Selection</button>

          <h2 style="margin-top:20px;">Favorites Queue</h2>
          <div class="row">
            <div class="field" style="min-width:140px; margin:0;">
              <label style="font-size:12px;" for="fav-day">Favorites Day</label>
              <select id="fav-day"></select>
            </div>
            <button id="build-queue-btn" class="ghost">Load Selected Day Into Chain</button>
            <button id="refresh-queue-btn" class="ghost">Refresh Queue</button>
          </div>
          <div id="queue-list" class="muted" style="margin-top:8px;">Queue not built yet.</div>

          <h2 style="margin-top:20px;">Server Log</h2>
          <pre id="log">Ready.</pre>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <h2 style="margin:0;">Current Session</h2>
            <button id="refresh-current-btn" class="ghost">Refresh</button>
          </div>
          <div class="muted">Single active draft per server. Finish or delete current draft before starting another.</div>

          <hr style="border:none;border-top:1px solid #e1e8e4; margin:14px 0;" />
          <h2>Active Draft</h2>
          <div id="selected-meta" class="muted">No active draft.</div>
          <div id="progress-block" style="margin-top:10px;">
            <div id="progress-label" class="muted">Idle</div>
            <div id="progress-cli" class="cli-box">[----------] 0%</div>
            <div class="progress-track"><div id="progress-fill" class="progress-fill"></div></div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="save-timings-btn" disabled>1) Save Ayah Timing Edits</button>
            <button id="prepare-subtitles-btn" class="secondary" disabled>2) Prepare Draft Audio + Subtitle Map</button>
            <button id="save-subtitles-btn" disabled>3) Save Subtitle Text Edits</button>
            <button id="render-final-btn" class="secondary" disabled>4) Render Final Reel</button>
            <button id="delete-draft-btn" class="ghost" disabled>Reset Current Session</button>
            <a id="download-final-btn" class="ghost" style="display:none; text-decoration:none;" download>Download Final</a>
          </div>

          <div id="players" style="display:none; margin-top:10px;">
            <h3 style="font-size:14px;">Preview Audio</h3>
            <audio id="preview-audio" controls></audio>
          </div>

          <h3 style="font-size:14px; margin-top:14px;">Ayah Timing Rows (Adjust First)</h3>
          <table class="timing-table" id="timing-table" style="display:none;">
            <thead><tr><th>Ayah</th><th>Start</th><th>End</th><th>Segment</th></tr></thead>
            <tbody id="timing-body"></tbody>
          </table>

          <h3 style="font-size:14px; margin-top:14px;">Subtitle Rows (After Prepare Step)</h3>
          <table class="subtitle-table" id="subtitle-table" style="display:none;">
            <thead><tr><th>Start</th><th>End</th><th>Text</th><th>State</th></tr></thead>
            <tbody id="subtitle-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const logEl = document.getElementById('log');
      const queueListEl = document.getElementById('queue-list');
      const timingTableEl = document.getElementById('timing-table');
      const timingBodyEl = document.getElementById('timing-body');
      const subtitleTableEl = document.getElementById('subtitle-table');
      const subtitleBodyEl = document.getElementById('subtitle-body');
      const selectedMetaEl = document.getElementById('selected-meta');
      const progressLabelEl = document.getElementById('progress-label');
      const progressCliEl = document.getElementById('progress-cli');
      const progressFillEl = document.getElementById('progress-fill');
      const saveTimingsBtn = document.getElementById('save-timings-btn');
      const prepareSubtitlesBtn = document.getElementById('prepare-subtitles-btn');
      const saveBtn = document.getElementById('save-subtitles-btn');
      const renderBtn = document.getElementById('render-final-btn');
      const deleteDraftBtn = document.getElementById('delete-draft-btn');
      const refreshCurrentBtn = document.getElementById('refresh-current-btn');
      const buildQueueBtn = document.getElementById('build-queue-btn');
      const refreshQueueBtn = document.getElementById('refresh-queue-btn');
      const favDayEl = document.getElementById('fav-day');
      const downloadFinalBtn = document.getElementById('download-final-btn');
      const playersEl = document.getElementById('players');
      const previewAudio = document.getElementById('preview-audio');
      const availableDaysEl = document.getElementById('available-days');
      const estimateBoxEl = document.getElementById('estimate-box');
      const genDayEl = document.getElementById('gen-day');
      const genSurahEl = document.getElementById('gen-surah');
      const genAyahStartEl = document.getElementById('gen-ayah-start');
      const genAyahEndEl = document.getElementById('gen-ayah-end');
      const segmentChainEl = document.getElementById('segment-chain');

      let selectedDraft = null;
      let queueItems = [];
      let favoriteDays = [];
      let ayahTimingRows = [];
      let subtitleRows = [];
      let availableDays = [];
      let currentEstimate = null;
      let dayIndex = { day: null, surahs: [] };
      let chainSegments = [];

      const setLog = (text) => { logEl.textContent = text; };
      const pretty = (obj) => JSON.stringify(obj, null, 2);
      const escapeHtml = (text) =>
        String(text ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;');
      const buildCliBar = (pct) => {
        const clamped = Math.max(0, Math.min(100, pct));
        const slots = 10;
        const filled = Math.round((clamped / 100) * slots);
        return `[${"#".repeat(filled)}${"-".repeat(slots - filled)}] ${clamped}%`;
      };
      const formatHMS = (seconds) => {
        const total = Math.max(0, Math.round(Number(seconds) || 0));
        const h = Math.floor(total / 3600);
        const m = Math.floor((total % 3600) / 60);
        const s = total % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      };

      async function api(url, options = {}) {
        const res = await fetch(url, options);
        const ct = res.headers.get('content-type') || '';
        const body = ct.includes('application/json') ? await res.json() : await res.text();
        if (!res.ok) {
          throw new Error(typeof body === 'string' ? body : pretty(body));
        }
        return body;
      }

      function renderTimingRows() {
        timingBodyEl.innerHTML = '';
        if (!ayahTimingRows.length) {
          timingTableEl.style.display = 'none';
          return;
        }
        timingTableEl.style.display = '';
        ayahTimingRows.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.surah_number}:${row.ayah}</td>
            <td><input data-k="start" data-i="${idx}" type="number" step="0.01" value="${row.start ?? 0}" /></td>
            <td><input data-k="end" data-i="${idx}" type="number" step="0.01" value="${row.end ?? 0}" /></td>
            <td>${row.segment_id || ''}</td>
          `;
          timingBodyEl.appendChild(tr);
        });
        timingBodyEl.querySelectorAll('input').forEach((field) => {
          field.addEventListener('input', () => {
            const i = Number(field.dataset.i);
            const k = field.dataset.k;
            ayahTimingRows[i][k] = Number(field.value);
          });
        });
      }

      function renderSubtitleRows() {
        subtitleBodyEl.innerHTML = '';
        if (!subtitleRows.length) {
          subtitleTableEl.style.display = 'none';
          return;
        }
        subtitleTableEl.style.display = '';

        subtitleRows.forEach((row, idx) => {
          const tr = document.createElement('tr');
          const stateLabel = row.verified ? 'Verified' : 'Draft';
          tr.innerHTML = `
            <td><input data-k="start" data-i="${idx}" type="number" step="0.01" value="${row.start ?? 0}" /></td>
            <td><input data-k="end" data-i="${idx}" type="number" step="0.01" value="${row.end ?? 0}" /></td>
            <td class="text-cell"><textarea data-k="text" data-i="${idx}">${escapeHtml(row.text || '')}</textarea></td>
            <td><span class="pill">${stateLabel}</span></td>
          `;
          subtitleBodyEl.appendChild(tr);
        });

        subtitleBodyEl.querySelectorAll('input, textarea').forEach((field) => {
          field.addEventListener('input', () => {
            const i = Number(field.dataset.i);
            const k = field.dataset.k;
            const v = field.value;
            subtitleRows[i][k] = (k === 'text') ? v : Number(v);
          });
        });
      }

      function clearActiveDraftView() {
        selectedDraft = null;
        ayahTimingRows = [];
        subtitleRows = [];
        renderTimingRows();
        renderSubtitleRows();
        playersEl.style.display = 'none';
        selectedMetaEl.textContent = 'No active draft.';
        saveTimingsBtn.disabled = true;
        prepareSubtitlesBtn.disabled = true;
        saveBtn.disabled = true;
        renderBtn.disabled = true;
        deleteDraftBtn.disabled = true;
        downloadFinalBtn.style.display = 'none';
        progressLabelEl.textContent = 'Idle';
        progressCliEl.textContent = buildCliBar(0);
        progressFillEl.style.width = '0%';
      }

      function draftProgress(draft) {
        if (!draft) return { pct: 0, label: 'Idle' };
        const status = String(draft.status || '');
        const step = String(draft.metadata?.step || '');
        if (status === 'failed') return { pct: 100, label: `Failed: ${step || 'error'}` };
        if (status === 'completed') return { pct: 100, label: 'Completed: final reel ready' };
        if (status === 'ready_for_timing') return { pct: 20, label: 'Ready: adjust ayah timings' };
        if (status === 'ready_for_edit') return { pct: 75, label: 'Ready: edit subtitle rows' };
        if (status === 'rendering_final') {
          const p = step === 'joining_final' ? 90 : 82;
          return { pct: p, label: `Rendering final: ${step || 'in progress'}` };
        }
        if (status === 'generating') {
          const map = {
            resolving_sources: 30,
            joining_preview: 52,
            building_subtitle_map: 62,
            extracting_audio: 72,
          };
          let pct = map[step] || 42;
          if (step.startsWith('processing_')) pct = 42;
          return { pct, label: `Preparing draft: ${step || 'in progress'}` };
        }
        return { pct: 10, label: status || 'Queued' };
      }

      function renderProgress(draft) {
        const { pct, label } = draftProgress(draft);
        progressLabelEl.textContent = label;
        progressCliEl.textContent = buildCliBar(pct);
        progressFillEl.style.width = `${pct}%`;
      }

      function renderQueue() {
        const selectedDay = Number(favDayEl.value);
        const scoped = queueItems.filter((item) => Number(item.day) === selectedDay);
        if (!scoped.length) {
          queueListEl.innerHTML = '<p class="muted">No favorites loaded for selected day.</p>';
          return;
        }
        queueListEl.innerHTML = `
          <div class="draft-row">
            <div class="row" style="justify-content:space-between;">
              <strong>Day ${selectedDay} Favorites</strong>
              <span class="pill">${scoped.length} segments</span>
            </div>
            <div class="muted" style="margin-top:6px;">
              ${scoped.map((item) => `${item.ayah_ref} — ${item.short_title || ''}`).join('<br/>')}
            </div>
          </div>
        `;
      }

      function renderFavoriteDays() {
        favDayEl.innerHTML = '';
        if (!favoriteDays.length) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No days';
          favDayEl.appendChild(option);
          return;
        }
        favoriteDays.forEach((day) => {
          const option = document.createElement('option');
          option.value = String(day);
          option.textContent = `Day ${day}`;
          favDayEl.appendChild(option);
        });
      }

      async function loadFavoriteDays() {
        const payload = await api('/favorites');
        const items = Array.isArray(payload.items) ? payload.items : [];
        const set = new Set();
        items.forEach((item) => {
          const day = Number(item.day);
          if (Number.isFinite(day) && day > 0) set.add(day);
        });
        favoriteDays = Array.from(set).sort((a, b) => a - b);
        renderFavoriteDays();
      }

      async function loadQueue() {
        const data = await api('/queue/current');
        const items = data.items;
        queueItems = Array.isArray(items) ? items : [];
        renderQueue();
      }

      function clearChain() {
        chainSegments = [];
        renderChain();
        setLog('Chain cleared.');
      }

      async function loadCurrentDraft() {
        const current = await api('/draft/current');
        if (!current) {
          clearActiveDraftView();
          return;
        }
        await openDraft(current.draft_id);
      }

      function renderAvailableDays() {
        if (!availableDays.length) {
          availableDaysEl.innerHTML = '<p class="muted">No synced marker data found yet.</p>';
          return;
        }
        availableDaysEl.innerHTML = '<p class="muted">Loading surah summary…</p>';
      }

      async function renderSurahSummary() {
        if (!availableDays.length) return;
        const responses = await Promise.all(
          availableDays.map((row) => api(`/markers/day/${row.day}/index`).catch(() => ({ day: row.day, surahs: [] })))
        );
        const map = new Map();
        responses.forEach((dayPayload) => {
          const day = Number(dayPayload.day);
          const surahs = Array.isArray(dayPayload.surahs) ? dayPayload.surahs : [];
          surahs.forEach((surah) => {
            const key = Number(surah.surah_number);
            if (!map.has(key)) {
              map.set(key, { surah_number: key, surah_name: surah.surah_name || `Surah ${key}`, days: [] });
            }
            const row = map.get(key);
            row.days.push({ day, ayah_min: surah.ayah_min, ayah_max: surah.ayah_max });
          });
        });
        const rows = Array.from(map.values()).sort((a, b) => a.surah_number - b.surah_number);
        availableDaysEl.innerHTML = rows
          .map((row) => {
            const dayText = row.days
              .sort((a, b) => a.day - b.day)
              .map((d) => `D${d.day}: ${d.ayah_min}-${d.ayah_max}`)
              .join(' · ');
            return `<div class="draft-row" style="margin-bottom:6px;">
              <div class="row" style="justify-content:space-between;">
                <strong>${row.surah_number} - ${row.surah_name}</strong>
                <span class="pill">${row.days.length} day(s)</span>
              </div>
              <div class="muted">${dayText}</div>
            </div>`;
          })
          .join('');
      }

      function setSelectOptions(selectEl, values, labelFn) {
        selectEl.innerHTML = '';
        values.forEach((value) => {
          const option = document.createElement('option');
          option.value = String(value);
          option.textContent = labelFn ? labelFn(value) : String(value);
          selectEl.appendChild(option);
        });
      }

      function renderChain() {
        if (!chainSegments.length) {
          segmentChainEl.innerHTML = 'No segments in chain.';
          return;
        }
        segmentChainEl.innerHTML = chainSegments
          .map((seg, idx) => (
            `<div class=\"draft-row\" style=\"margin-bottom:6px;\">
              <div class=\"row\" style=\"justify-content:space-between;\">
                <strong>#${idx + 1} Day ${seg.day}</strong>
                <button class=\"ghost\" data-remove-segment=\"${idx}\">Remove</button>
              </div>
              <div class=\"muted\">${seg.surah_number}:${seg.ayah_start}-${seg.ayah_end} · ${formatHMS(seg.duration)} · ${seg.sheikh || 'Unknown'} · ${seg.source_id || 'source:auto'}</div>
            </div>`
          ))
          .join('');

        segmentChainEl.querySelectorAll('[data-remove-segment]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.removeSegment);
            chainSegments.splice(idx, 1);
            renderChain();
          });
        });
      }

      async function loadAvailableDays() {
        availableDays = await api('/markers/available');
        renderAvailableDays();
        await renderSurahSummary();
        const dayOptions = availableDays.map((row) => row.day);
        if (dayOptions.length) {
          setSelectOptions(genDayEl, dayOptions);
          if (!dayOptions.includes(Number(genDayEl.value))) {
            genDayEl.value = String(dayOptions[0]);
          }
          await loadDayIndex();
        } else {
          genDayEl.innerHTML = '';
          genSurahEl.innerHTML = '';
          genAyahStartEl.innerHTML = '';
          genAyahEndEl.innerHTML = '';
        }
      }

      async function loadDayIndex() {
        const day = Number(genDayEl.value);
        dayIndex = await api(`/markers/day/${day}/index`);
        const surahs = Array.isArray(dayIndex.surahs) ? dayIndex.surahs : [];
        if (!surahs.length) {
          genSurahEl.innerHTML = '';
          genAyahStartEl.innerHTML = '';
          genAyahEndEl.innerHTML = '';
          return;
        }

        const surahValues = surahs.map((s) => s.surah_number);
        setSelectOptions(genSurahEl, surahValues, (num) => {
          const row = surahs.find((s) => s.surah_number === Number(num));
          return `${row.surah_number} - ${row.surah_name}`;
        });
        if (!surahValues.includes(Number(genSurahEl.value))) {
          genSurahEl.value = String(surahValues[0]);
        }
        populateAyahSelectors();
      }

      function populateAyahSelectors() {
        const surahNumber = Number(genSurahEl.value);
        const surah = (dayIndex.surahs || []).find((s) => s.surah_number === surahNumber);
        const ayahs = Array.isArray(surah?.ayahs) ? surah.ayahs : [];
        if (!ayahs.length) {
          genAyahStartEl.innerHTML = '';
          genAyahEndEl.innerHTML = '';
          return;
        }

        setSelectOptions(genAyahStartEl, ayahs);
        setSelectOptions(genAyahEndEl, ayahs);

        if (!ayahs.includes(Number(genAyahStartEl.value))) {
          genAyahStartEl.value = String(ayahs[0]);
        }
        if (!ayahs.includes(Number(genAyahEndEl.value))) {
          genAyahEndEl.value = String(ayahs[ayahs.length - 1]);
        }
        clampAyahRange();
      }

      function clampAyahRange() {
        const start = Number(genAyahStartEl.value);
        const end = Number(genAyahEndEl.value);
        if (end < start) {
          genAyahEndEl.value = String(start);
        }
      }

      function getEstimateInputs() {
        return {
          day: Number(document.getElementById('gen-day').value),
          surah_number: Number(document.getElementById('gen-surah').value),
          ayah_start: Number(document.getElementById('gen-ayah-start').value),
          ayah_end: Number(document.getElementById('gen-ayah-end').value),
        };
      }

      async function loadEstimate() {
        const input = getEstimateInputs();
        if (!Number.isFinite(input.day) || !Number.isFinite(input.surah_number) || !Number.isFinite(input.ayah_start) || !Number.isFinite(input.ayah_end)) {
          return;
        }
        const query = new URLSearchParams({
          day: String(input.day),
          surah_number: String(input.surah_number),
          ayah_start: String(input.ayah_start),
          ayah_end: String(input.ayah_end),
        }).toString();
        currentEstimate = await api(`/draft/estimate?${query}`);
        const source = currentEstimate.source_url || 'not provided';
        estimateBoxEl.innerHTML = `
          Clip Start: <strong>${formatHMS(currentEstimate.estimated_clip_start)}</strong><br/>
          Duration: <strong>${formatHMS(currentEstimate.estimated_duration)}</strong><br/>
          Sheikh: <strong>${currentEstimate.estimated_sheikh || 'Unknown'}</strong><br/>
          Source: <strong>${source}</strong><br/>
          Markers in range: <strong>${currentEstimate.marker_count_in_range}</strong>
        `;
      }

      async function openDraft(draftId) {
        selectedDraft = await api(`/draft/${draftId}`);
        selectedMetaEl.textContent = `Draft ${selectedDraft.draft_id} · ${selectedDraft.status}${selectedDraft.running ? ' · Running' : ''}`;
        renderProgress(selectedDraft);
        saveTimingsBtn.disabled = false;
        prepareSubtitlesBtn.disabled = false;
        saveBtn.disabled = selectedDraft.status !== 'ready_for_edit' && selectedDraft.status !== 'completed';
        renderBtn.disabled = selectedDraft.status !== 'ready_for_edit' && selectedDraft.status !== 'completed';
        deleteDraftBtn.disabled = false;

        const tmEdited = selectedDraft.artifact_urls.ayah_timing_map_edited;
        const tm = selectedDraft.artifact_urls.ayah_timing_map;
        let timingMap = { chunks: [] };
        try { timingMap = await api(tmEdited); } catch (_) {
          try { timingMap = await api(tm); } catch (_) { timingMap = { chunks: [] }; }
        }
        ayahTimingRows = Array.isArray(timingMap.chunks) ? timingMap.chunks : [];
        renderTimingRows();

        const smEdited = selectedDraft.artifact_urls.subtitle_map_edited;
        const sm = selectedDraft.artifact_urls.subtitle_map;
        let map = { chunks: [] };
        try { map = await api(smEdited); } catch (_) {
          try { map = await api(sm); } catch (_) { map = { chunks: [] }; }
        }
        subtitleRows = Array.isArray(map.chunks) ? map.chunks : [];
        renderSubtitleRows();

        previewAudio.src = selectedDraft.artifact_urls.audio;
        downloadFinalBtn.href = selectedDraft.artifact_urls.final_video;
        downloadFinalBtn.download = `${selectedDraft.draft_id}-final.mp4`;
        downloadFinalBtn.style.display = (selectedDraft.status === 'completed') ? '' : 'none';
        playersEl.style.display = (selectedDraft.status === 'ready_for_edit' || selectedDraft.status === 'completed') ? '' : 'none';
      }
      refreshCurrentBtn.addEventListener('click', async () => {
        try {
          await loadCurrentDraft();
          setLog('Current session refreshed.');
        } catch (err) {
          setLog(String(err));
        }
      });

      buildQueueBtn.addEventListener('click', async () => {
        try {
          const selectedDay = Number(favDayEl.value);
          if (!Number.isFinite(selectedDay) || selectedDay < 1) {
            setLog('Select a valid favorites day first.');
            return;
          }
          const out = await api('/queue/from-favorites', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days: [selectedDay], include_theme_types: ["Dua", "Famous Ayah"], full_refresh: true }),
          });
          const queue = await api('/queue/current');
          const items = Array.isArray(queue.items) ? queue.items : [];
          chainSegments = items.map((row) => ({
            day: row.day,
            surah_number: row.surah_number,
            ayah_start: row.ayah_start,
            ayah_end: row.ayah_end,
          }));
          renderChain();
          setLog(`Loaded ${chainSegments.length} favorite segments for day ${selectedDay}.`);
          await loadQueue();
        } catch (err) {
          setLog(String(err));
        }
      });

      refreshQueueBtn.addEventListener('click', async () => {
        try {
          await loadQueue();
          setLog('Queue refreshed.');
        } catch (err) {
          setLog(String(err));
        }
      });

      favDayEl.addEventListener('change', () => {
        renderQueue();
      });

      document.getElementById('generate-btn').addEventListener('click', async () => {
        try {
          if (!chainSegments.length) {
            await loadEstimate();
            if (currentEstimate) {
              chainSegments = [{
                day: currentEstimate.day,
                surah_number: currentEstimate.surah_number,
                ayah_start: currentEstimate.ayah_start,
                ayah_end: currentEstimate.ayah_end,
              }];
            }
          }
          const payload = {
            segments: chainSegments,
            align_subtitles: true,
          };
          const out = await api('/draft/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          setLog(pretty(out));
          await openDraft(out.draft_id);
        } catch (err) {
          setLog(String(err));
        }
      });

      document.getElementById('add-segment-btn').addEventListener('click', async () => {
        try {
          await loadEstimate();
          if (!currentEstimate) return;
          chainSegments.push({
            day: currentEstimate.day,
            surah_number: currentEstimate.surah_number,
            ayah_start: currentEstimate.ayah_start,
            ayah_end: currentEstimate.ayah_end,
            clip_start: currentEstimate.estimated_clip_start,
            duration: currentEstimate.estimated_duration,
            sheikh: currentEstimate.estimated_sheikh,
            source_id: currentEstimate.source_id,
          });
          renderChain();
          setLog(`Added segment ${currentEstimate.day}:${currentEstimate.surah_number}:${currentEstimate.ayah_start}-${currentEstimate.ayah_end}`);
        } catch (err) {
          setLog(String(err));
        }
      });

      document.getElementById('clear-segments-btn').addEventListener('click', (event) => {
        event.preventDefault();
        clearChain();
      });

      saveBtn.addEventListener('click', async () => {
        if (!selectedDraft) return;
        try {
          const payload = { draft_id: selectedDraft.draft_id, chunks: subtitleRows };
          const out = await api('/draft/update-subtitles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          setLog(pretty(out));
          await openDraft(selectedDraft.draft_id);
        } catch (err) {
          setLog(String(err));
        }
      });

      saveTimingsBtn.addEventListener('click', async () => {
        if (!selectedDraft) return;
        try {
          const payload = { draft_id: selectedDraft.draft_id, chunks: ayahTimingRows };
          const out = await api('/draft/update-ayah-timings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          setLog(pretty(out));
          await openDraft(selectedDraft.draft_id);
        } catch (err) {
          setLog(String(err));
        }
      });

      prepareSubtitlesBtn.addEventListener('click', async () => {
        if (!selectedDraft) return;
        try {
          const payload = { draft_id: selectedDraft.draft_id };
          const out = await api('/draft/prepare-subtitles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          setLog(pretty(out));
          await openDraft(selectedDraft.draft_id);
        } catch (err) {
          setLog(String(err));
        }
      });

      renderBtn.addEventListener('click', async () => {
        if (!selectedDraft) return;
        try {
          const payload = { draft_id: selectedDraft.draft_id };
          const out = await api('/render/final', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          setLog(pretty(out));
          await openDraft(selectedDraft.draft_id);
        } catch (err) {
          setLog(String(err));
        }
      });

      deleteDraftBtn.addEventListener('click', async () => {
        if (!selectedDraft) return;
        try {
          const out = await api(`/draft/${selectedDraft.draft_id}`, { method: 'DELETE' });
          setLog(pretty(out));
          selectedDraft = null;
          ayahTimingRows = [];
          subtitleRows = [];
          renderTimingRows();
          renderSubtitleRows();
          playersEl.style.display = 'none';
          selectedMetaEl.textContent = 'No active draft.';
          saveTimingsBtn.disabled = true;
          prepareSubtitlesBtn.disabled = true;
          saveBtn.disabled = true;
          renderBtn.disabled = true;
          deleteDraftBtn.disabled = true;
          downloadFinalBtn.style.display = 'none';
        } catch (err) {
          setLog(String(err));
        }
      });

      ['gen-day', 'gen-surah', 'gen-ayah-start', 'gen-ayah-end'].forEach((id) => {
        const el = document.getElementById(id);
        el.addEventListener('change', async () => {
          try {
            if (id === 'gen-day') {
              await loadDayIndex();
            }
            if (id === 'gen-surah') {
              populateAyahSelectors();
            }
            if (id === 'gen-ayah-start' || id === 'gen-ayah-end') {
              clampAyahRange();
            }
            await loadEstimate();
          } catch (err) {
            estimateBoxEl.textContent = `Estimate unavailable: ${String(err)}`;
          }
        });
      });

      clearActiveDraftView();
      loadCurrentDraft().catch((err) => setLog(String(err)));
      loadFavoriteDays().catch((err) => setLog(String(err)));
      loadQueue().catch(() => {});
      loadAvailableDays()
        .then(() => loadEstimate())
        .catch((err) => {
          setLog(String(err));
          estimateBoxEl.textContent = `Estimate unavailable: ${String(err)}`;
        });
      renderChain();
      setInterval(async () => {
        try {
          if (selectedDraft) {
            await openDraft(selectedDraft.draft_id);
          } else {
            await loadCurrentDraft();
          }
          await loadQueue();
          const currentDay = Number(genDayEl.value || 0);
          await loadAvailableDays();
          if (Number(genDayEl.value || 0) !== currentDay) {
            await loadDayIndex();
          }
        } catch (_) {}
      }, 8000);
    </script>
  </body>
</html>
